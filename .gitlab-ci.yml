stages: 
  #- build
  - build-images
  - deploy
  
#build-bot:
#  stage: build
#  image: node

build-bot-image: #used to build the bot's docker image
  stage: build-images
  image: docker.io/buildah/buildah
  needs: []
  script:
    - export _BUILDAH_STARTED_IN_USERNS=''
    - export BUILDAH_ISOLATION=chroot
    - export STORAGE_DRIVER=vfs
    - export BUILDAH_FORMAT=docker
    
    - buildah build-using-dockerfile --tag "rostbot" "rostbot"
    - buildah push --creds "${CI_REGISTRY_USER}:${CI_JOB_TOKEN}" "rostbot" "docker://${CI_REGISTRY_IMAGE}/rostbot:latest"

deploy-bot:
 environment: 'production'
 needs:
   - build-bot-image
 rules: 
   - if: '$CI_COMMIT_BRANCH == "18-misc-add-continuous-integration"' #Change to master

 stage: deploy
 image: lachlanevenson/k8s-kubectl
 script:
   - kubectl create secret docker-registry gitlab.liu.se --docker-server=${​​​​​CI_REGISTRY}​​​​​ --docker-username=${​​​​​CI_DEPLOY_USER}​​​​​ --docker-password=${​​​​​CI_DEPLOY_PASSWORD}​​​​​ --dry-run -o yaml | kubectl apply -f -
   - kubectl get all
   - kubectl apply -f rostbot/bot-deploy.yaml
   - kubectl apply -f rostbot/bot-service.yaml
   - kubectl apply -f rostbot/bot-ingress.yaml
   - sleep 10
   - kubectl get all # display container status

  